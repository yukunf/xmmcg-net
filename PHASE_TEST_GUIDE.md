# ç«æ ‡ç³»ç»Ÿé˜¶æ®µæ£€æŸ¥æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•ç¯å¢ƒæ¦‚è§ˆ

### å·²åˆ›å»ºçš„æµ‹è¯•é˜¶æ®µ

| é˜¶æ®µåç§° | phase_key | å®æ—¶çŠ¶æ€ | is_active | å¼€å§‹æ—¶é—´ | ç»“æŸæ—¶é—´ |
|---------|-----------|---------|-----------|---------|---------|
| æ­Œæ›²æäº¤æœŸ | music_submit | ğŸ”´ å·²ç»“æŸ | False | 2å°æ—¶å‰ | 1å°æ—¶å‰ |
| **æ­Œæ›²ç«æ ‡æœŸ** | **song_bid** | **âœ… è¿›è¡Œä¸­** | **True** | 30åˆ†é’Ÿå‰ | 30åˆ†é’Ÿå |
| è°±é¢åˆ¶ä½œæœŸ | chart_mapping | â³ æœªå¼€å§‹ | False | 1å°æ—¶å | 3å°æ—¶å |
| è°±é¢ç«æ ‡æœŸ | chart_bid | â³ æœªå¼€å§‹ | False | 4å°æ—¶å | 6å°æ—¶å |
| äº’è¯„æœŸ | peer_review | â³ æœªå¼€å§‹ | False | 7å°æ—¶å | 10å°æ—¶å |

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1ï¸âƒ£ åç«¯ Django Management Command æµ‹è¯•

#### æµ‹è¯• Dry-Run æ¨¡å¼
```bash
cd backend/xmmcg
python manage.py update_phase_status --dry-run
```

**é¢„æœŸè¾“å‡ºï¼š**
```
[DRY RUN] å°†åœç”¨: æ­Œæ›²æäº¤æœŸ (phase_key: music_submit)
[DRY RUN] å°†åœç”¨: è°±é¢åˆ¶ä½œæœŸ (phase_key: chart_mapping)
[DRY RUN] å°†åœç”¨: è°±é¢ç«æ ‡æœŸ (phase_key: chart_bid)
[DRY RUN] å°†åœç”¨: äº’è¯„æœŸ (phase_key: peer_review)

å½“å‰æ´»è·ƒé˜¶æ®µ:
  â€¢ æ­Œæ›²ç«æ ‡æœŸ (song_bid)
```

#### æ‰§è¡Œå®é™…æ›´æ–°
```bash
python manage.py update_phase_status
```

**é¢„æœŸè¡Œä¸ºï¼š**
- âœ… å·²è¿‡æœŸçš„é˜¶æ®µ â†’ is_active æ”¹ä¸º False
- âœ… è¿›è¡Œä¸­çš„é˜¶æ®µ â†’ is_active ä¿æŒ True
- âœ… æœªå¼€å§‹çš„é˜¶æ®µ â†’ is_active æ”¹ä¸º False

#### éªŒè¯æ•°æ®åº“çŠ¶æ€
```bash
python verify_phase_status.py
```

---

### 2ï¸âƒ£ å‰ç«¯ Vue ç»„ä»¶æµ‹è¯•

#### å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
```bash
cd front
npm run dev
```

è®¿é—®ï¼šhttp://localhost:5173

#### æµ‹è¯• Songs é¡µé¢

**æµ‹è¯•ç‚¹ 1ï¼šæ­Œæ›²ç«æ ‡æŒ‰é’®æ˜¾ç¤º**
- å¯¼èˆªåˆ° Songs é¡µé¢
- âœ… **åº”èƒ½çœ‹åˆ°** "ç«æ ‡" æŒ‰é’®ï¼ˆå› ä¸º song_bid æ­£åœ¨è¿›è¡Œï¼‰
- æŒ‰é’®åº”ç”¨æ¡ä»¶ï¼š`v-if="isSongBiddingPhase() && !isMyOwnSong(song)"`

**æµ‹è¯•ç‚¹ 2ï¼šç«æ ‡åŠŸèƒ½å¯ç”¨æ€§**
- ç‚¹å‡» "ç«æ ‡" æŒ‰é’®
- âœ… **åº”èƒ½æ­£å¸¸æ‰“å¼€** ç«æ ‡å¯¹è¯æ¡†
- âœ… **åç«¯åº”æ¥å—** ç«æ ‡è¯·æ±‚ï¼ˆå› ä¸º is_active=Trueï¼‰

**æµ‹è¯•ç‚¹ 3ï¼šæ§åˆ¶å°éªŒè¯**
æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Consoleï¼š
```javascript
// æ£€æŸ¥é˜¶æ®µæ•°æ®
allCompetitionPhases.value.find(p => p.phase_key === 'song_bid')
// åº”è¿”å›ï¼š{ phase_key: 'song_bid', is_active: true, ... }
```

#### æµ‹è¯• Charts é¡µé¢

**æµ‹è¯•ç‚¹ 1ï¼šè°±é¢ç«æ ‡æŒ‰é’®éšè—**
- å¯¼èˆªåˆ° Charts é¡µé¢
- âŒ **åº”çœ‹ä¸åˆ°** "ç«æ ‡" æŒ‰é’®ï¼ˆå› ä¸º chart_bid æœªå¼€å§‹ï¼‰
- æŒ‰é’®æ¡ä»¶ï¼š`v-if="isChartBiddingPhase() && ..."`

**æµ‹è¯•ç‚¹ 2ï¼šæ§åˆ¶å°éªŒè¯**
```javascript
// æ£€æŸ¥é˜¶æ®µæ•°æ®
currentPhase.value
// åº”è¿”å›ï¼š{ phase_key: 'chart_bid', is_active: false, status: 'upcoming', ... }

// æ£€æŸ¥å‡½æ•°è¿”å›å€¼
isChartBiddingPhase()
// åº”è¿”å›ï¼šfalse
```

---

### 3ï¸âƒ£ æƒé™ç»•è¿‡æµ‹è¯•ï¼ˆå®‰å…¨éªŒè¯ï¼‰

#### æµ‹è¯•åœºæ™¯ï¼šç”¨æˆ·å°è¯•åœ¨è¿‡æœŸåæäº¤ç«æ ‡

**æ—§ç‰ˆæœ¬æ¼æ´ï¼ˆå·²ä¿®å¤ï¼‰ï¼š**
ç”¨æˆ·å¯é€šè¿‡ç›´æ¥æä¾› `round_id` ç»•è¿‡æ—¶é—´æ£€æŸ¥

**æ–°ç‰ˆæœ¬é˜²æŠ¤ï¼š**

1. **å‰ç«¯æµ‹è¯•ï¼ˆ30åˆ†é’Ÿåï¼‰**
   ```bash
   # ç­‰å¾… song_bid é˜¶æ®µç»“æŸï¼ˆæˆ–æ‰‹åŠ¨ä¿®æ”¹ç»“æŸæ—¶é—´ï¼‰
   python manage.py update_phase_status
   ```
   - åˆ·æ–° Songs é¡µé¢
   - âŒ ç«æ ‡æŒ‰é’®åº”æ¶ˆå¤±

2. **åç«¯ API æµ‹è¯•**
   ä½¿ç”¨ Postman/curl ç›´æ¥è°ƒç”¨ APIï¼š
   ```bash
   POST /api/user-bids/
   {
     "song": 1,
     "round_id": 1,  # å°è¯•ç»•è¿‡æ£€æŸ¥
     "priority": 1
   }
   ```
   
   **é¢„æœŸå“åº”ï¼ˆéç®¡ç†å‘˜ï¼‰ï¼š**
   ```json
   {
     "error": "å½“å‰ä¸åœ¨ç«æ ‡é˜¶æ®µ"
   }
   ```
   
   **ç®¡ç†å‘˜ä¾‹å¤–ï¼š**
   - âœ… ç®¡ç†å‘˜å¯ä»¥ç»•è¿‡ is_active æ£€æŸ¥
   - ç”¨äºæµ‹è¯•å’Œæ•°æ®ä¿®æ­£

---

### 4ï¸âƒ£ å®šæ—¶ä»»åŠ¡æ¨¡æ‹Ÿæµ‹è¯•

#### æµ‹è¯•æ™ºèƒ½é¢‘ç‡è°ƒæ•´

**åœºæ™¯ 1ï¼šè·ç¦»é˜¶æ®µåˆ‡æ¢ > 2 å°æ—¶**
```bash
# å½“å‰è·ç¦» song_bid ç»“æŸè¿˜æœ‰ 3 å°æ—¶
cd scripts
bash smart_update_phase.sh
```
**é¢„æœŸè¡Œä¸ºï¼š**
```
è·ç¦»ä¸‹æ¬¡é˜¶æ®µåˆ‡æ¢: 10800 ç§’ (3.0 å°æ—¶)
æ‰§è¡Œé¢‘ç‡: æ¯ 3600 ç§’ (1 å°æ—¶)
```

**åœºæ™¯ 2ï¼šè·ç¦»é˜¶æ®µåˆ‡æ¢ < 2 å°æ—¶**
```bash
# æ‰‹åŠ¨ä¿®æ”¹ song_bid ç»“æŸæ—¶é—´ä¸º 1 å°æ—¶å
cd scripts
bash smart_update_phase.sh
```
**é¢„æœŸè¡Œä¸ºï¼š**
```
è·ç¦»ä¸‹æ¬¡é˜¶æ®µåˆ‡æ¢: 3600 ç§’ (1.0 å°æ—¶)
âš ï¸  è·ç¦»é˜¶æ®µåˆ‡æ¢ä¸è¶³ 2 å°æ—¶ï¼Œä½¿ç”¨é«˜é¢‘æ¨¡å¼
æ‰§è¡Œé¢‘ç‡: æ¯ 600 ç§’ (10 åˆ†é’Ÿ)
```

---

## ğŸ” å…³é”®éªŒè¯ç‚¹æ€»ç»“

### âœ… å¿…é¡»é€šè¿‡çš„æµ‹è¯•

1. **åç«¯æƒé™æ£€æŸ¥**
   - [ ] å·²è¿‡æœŸé˜¶æ®µ â†’ æ— æ³•æäº¤ç«æ ‡
   - [ ] è¿›è¡Œä¸­é˜¶æ®µ â†’ å¯ä»¥æäº¤ç«æ ‡
   - [ ] æœªå¼€å§‹é˜¶æ®µ â†’ æ— æ³•æäº¤ç«æ ‡
   - [ ] ç®¡ç†å‘˜ â†’ å¯ç»•è¿‡æ£€æŸ¥

2. **å‰ç«¯æŒ‰é’®æ˜¾ç¤º**
   - [ ] song_bid è¿›è¡Œä¸­ â†’ Songs é¡µé¢æ˜¾ç¤ºç«æ ‡æŒ‰é’®
   - [ ] song_bid ç»“æŸå â†’ Songs é¡µé¢éšè—ç«æ ‡æŒ‰é’®
   - [ ] chart_bid æœªå¼€å§‹ â†’ Charts é¡µé¢éšè—ç«æ ‡æŒ‰é’®
   - [ ] chart_bid å¼€å§‹å â†’ Charts é¡µé¢æ˜¾ç¤ºç«æ ‡æŒ‰é’®

3. **è‡ªåŠ¨çŠ¶æ€æ›´æ–°**
   - [ ] dry-run æ¨¡å¼ä¸ä¿®æ”¹æ•°æ®åº“
   - [ ] å®é™…æ‰§è¡Œæ­£ç¡®æ›´æ–° is_active
   - [ ] æ™ºèƒ½é¢‘ç‡è°ƒæ•´å·¥ä½œæ­£å¸¸
   - [ ] å®šæ—¶ä»»åŠ¡æ­£ç¡®æ‰§è¡Œ

4. **å‰åç«¯ä¸€è‡´æ€§**
   - [ ] å‰ç«¯æ£€æŸ¥ is_active
   - [ ] åç«¯æ£€æŸ¥ is_active
   - [ ] åŒé‡é˜²æŠ¤æœºåˆ¶æœ‰æ•ˆ

---

## ğŸ“Š æµ‹è¯•ç»“æœè®°å½•

### æµ‹è¯•æ‰§è¡Œæ—¶é—´
- **åˆ›å»ºé˜¶æ®µ:** 2026-01-30 14:30:42 CST
- **å½“å‰æ—¶é—´:** ___________
- **æµ‹è¯•å®Œæˆ:** ___________

### æµ‹è¯•ç»“æœ
- [ ] åç«¯ Management Command âœ… / âŒ
- [ ] Songs é¡µé¢ç«æ ‡æŒ‰é’® âœ… / âŒ
- [ ] Charts é¡µé¢ç«æ ‡æŒ‰é’® âœ… / âŒ
- [ ] æƒé™ç»•è¿‡é˜²æŠ¤ âœ… / âŒ
- [ ] å®šæ—¶ä»»åŠ¡è„šæœ¬ âœ… / âŒ

### å‘ç°çš„é—®é¢˜
```
è®°å½•æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°çš„ä»»ä½•é—®é¢˜...
```

---

## ğŸ› ï¸ è°ƒè¯•å·¥å…·

### å¿«é€Ÿæ£€æŸ¥å½“å‰çŠ¶æ€
```bash
cd backend/xmmcg
python verify_phase_status.py
```

### æ‰‹åŠ¨è§¦å‘çŠ¶æ€æ›´æ–°
```bash
python manage.py update_phase_status
```

### æŸ¥çœ‹ Django Shell æ•°æ®
```bash
python manage.py shell
```
```python
from songs.models import CompetitionPhase
from django.utils import timezone

# æŸ¥çœ‹æ‰€æœ‰é˜¶æ®µ
for p in CompetitionPhase.objects.all():
    print(f"{p.name}: status={p.status}, is_active={p.is_active}")

# æŸ¥çœ‹å½“å‰æ´»è·ƒé˜¶æ®µ
active = CompetitionPhase.objects.filter(is_active=True)
print(f"å½“å‰æ´»è·ƒ: {[p.name for p in active]}")
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ—¶åŒºé—®é¢˜**
   - å·²é…ç½® `TIME_ZONE = 'Asia/Shanghai'`
   - æ‰€æœ‰æ—¶é—´ä½¿ç”¨ CST (UTC+8)

2. **å‰ç«¯ç¼“å­˜**
   - æµ‹è¯•æ—¶å»ºè®®ç¡¬åˆ·æ–°ï¼ˆCtrl+Shift+Rï¼‰
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

3. **åç«¯ç¼“å­˜**
   - Django ä¸ç¼“å­˜ is_active å­—æ®µ
   - å®æ—¶æŸ¥è¯¢æ•°æ®åº“

4. **å®šæ—¶ä»»åŠ¡**
   - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ cron æˆ– systemd timer
   - å»ºè®®æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆæˆ–ä½¿ç”¨æ™ºèƒ½é¢‘ç‡è„šæœ¬ï¼‰

---

**æµ‹è¯•å®Œæˆåï¼Œåˆ«å¿˜äº†æ¸…ç†æµ‹è¯•æ•°æ®ï¼**
```bash
python manage.py shell
>>> from songs.models import CompetitionPhase
>>> CompetitionPhase.objects.filter(phase_key__in=['music_submit', 'song_bid', 'chart_mapping', 'chart_bid', 'peer_review']).delete()
```
