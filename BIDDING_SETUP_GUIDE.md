# 竞标轮次设置指南

## 架构改变

原来的系统使用独立的 `BiddingRound` 管理竞标轮次，导致状态混乱、无法在后台管理。现在改为通过 **CompetitionPhase（比赛阶段）** 来管理竞标轮次。

## 工作原理

1. **CompetitionPhase** - 代表一个比赛阶段，包含时间范围和页面访问权限
2. 竞标系统会自动识别 `phase_key` 包含 `bidding` 的阶段
3. 根据当前时间自动判断阶段状态：
   - `pending` - 未开始（current_time < start_time）
   - `active` - 进行中（start_time < current_time < end_time）
   - `completed` - 已完成（current_time > end_time）

## 设置步骤

### 1. 创建第一轮竞标阶段

进入后台管理面板 (`/admin/`)，选择 **比赛阶段**，点击 **添加比赛阶段**。

填写以下信息：

| 字段 | 值 | 说明 |
|------|-----|------|
| 阶段名称 | 第一轮竞标 | 显示在前端时间轴 |
| 唯一标识符 | bidding_round1 | 必须包含 `bidding` |
| 描述 | 竞标期 - 用户可在此期间对歌曲竞标 | 显示详情 |
| 开始时间 | 2026-01-20 09:00:00 | 竞标开始时间 |
| 结束时间 | 2026-01-22 17:00:00 | 竞标截止时间 |
| 显示顺序 | 1 | 时间轴顺序 |
| 启用此阶段 | ✓ | 勾选以启用 |

**页面访问权限配置（JSON 格式）：**
```json
{
  "songs": true,
  "charts": false,
  "profile": true
}
```

点击 **保存**。

### 2. 创建第二轮竞标阶段

重复上述步骤，修改：

| 字段 | 值 |
|------|-----|
| 阶段名称 | 第二轮竞标 |
| 唯一标识符 | bidding_round2 |
| 开始时间 | 2026-01-23 09:00:00 |
| 结束时间 | 2026-01-25 17:00:00 |
| 显示顺序 | 2 |

### 3. 管理竞标数据

现在可以在后台管理竞标数据：

#### 竞标轮次管理
- 位置：**竞标轮次** 
- 显示所有竞标的基本信息
- 支持按状态筛选

#### 用户竞标管理
- 位置：**竞标**
- 查看用户的具体竞标情况
- 支持按用户、歌曲、轮次筛选
- 可手动标记"已放弃"（is_dropped）

#### 竞标结果管理
- 位置：**竞标结果**
- 查看分配结果
- 显示获胜竞标和分配类型

## 前端使用体验

1. **自动识别活跃阶段**
   - 系统会自动获取当前活跃的竞标阶段
   - 用户只能对活跃阶段进行竞标

2. **限制机制**
   - 每轮最多竞标 5 首
   - 代币不足无法竞标
   - 系统自动验证

3. **多轮支持**
   - 第一轮结束后，第二轮自动开启
   - 结果自动计算和分配

## 关键改进

✅ 后台可直接管理（不再显示"已完成"）
✅ 支持无限多轮竞标
✅ 时间自动控制状态
✅ 前端自动适配

## 技术细节

### API 变化

**GET /api/bidding-rounds/** 现在返回：
```json
{
  "success": true,
  "count": 2,
  "rounds": [
    {
      "id": 1,
      "name": "第一轮竞标",
      "status": "completed",
      "phase_key": "bidding_round1",
      "start_time": "2026-01-20T09:00:00Z",
      "end_time": "2026-01-22T17:00:00Z",
      "description": "竞标期 - 用户可在此期间对歌曲竞标",
      "bid_count": 12
    }
  ]
}
```

### CompetitionPhase 字段

- `name`: 显示给用户的阶段名称
- `phase_key`: 系统标识符（竞标阶段包含 `bidding`）
- `start_time`/`end_time`: 时间范围
- `page_access`: JSON 格式的页面访问控制
- `is_active`: 全局启用/禁用开关

## 故障排除

### 问题：前端显示"当前没有活跃的竞标轮次"

**排查步骤：**
1. 检查后台是否有 CompetitionPhase
2. 确保 `phase_key` 包含 "bidding" 字样
3. 检查时间设置是否正确
4. 确保 `is_active` 为启用状态

### 问题：竞标数据未显示

**排查步骤：**
1. 检查竞标轮次是否为"进行中"状态
2. 在 **竞标** 页面查看具体竞标记录
3. 确保用户有足够代币

